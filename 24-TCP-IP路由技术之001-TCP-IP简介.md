<!--markdown-->[图]TCP/IP协议簇与OSI参考模型的关系

![IP包头格式](https://raw.githubusercontent.com/zyywo/zyywo.pic/master/IP%E6%8A%A5%E5%A4%B4.png "IP包头格式")


**header length**(报头长度)：此字段长度为4位，单位是4字节，因此IP报头不会超过(2<sup>4</sup>-1)x4字节。

**Type of Service**(服务类型)：此字段长度为8位，现已作为区分服务（Diffserv）被重新定义了。在Diffserv下，我们能够在一台路由器上定义服务分类，将数据包归类到这些分类中去，路由器可以根据它们的分类使用不同的优先级对数据包进行排序和转发。

**Total Length**(总长度)：此字段长度为16位，单位是1字节，其中包括IP报头。

**Identifier**(标识符)：此字段长度为16位，如果数据包原始长度超过数据包所要经过的数据链路的最大传输单元（MTU），那么必须将数据包分段为更小的数据包，被分段的数据包一直保持分段状态，直至到达最终目的时才会被重组。

**Flag**(标记)：此字段长度为3位，其中第1位保留，第2位是不分段（DF）位。当DF位为1时，表示路由器不能对数据包进行分段处理，如果数据包由于不能被分段而未能被转发，那么路由器将丢弃该数据包并向源点发送错误消息。第3位是更多分段（MF）位，当路由器对数据包进行分段时，除了最后一个分段的MF位设置为0外，其他所有分段的MF位均设置为1,以便接收者直到收到MF位为0的分段为止。

**Fragment Offset**(分段偏移)：此字段长度为13位，单位是8字节，用于指明分段起始点相对于报头起始点的偏移量，使接收者能够按照正确的顺序重组数据包。如果其中一个分段丢失，那么会对整个数据包重新分段并重新发送。

**Header Checksum**(头部校验和)：校验和不计算被封装的数据，但由于每台路由器都会修改TTL值，所以每台路由器都会重新计算校验和。

### 地址解析协议（ARP）
路由器可以沿逻辑路径传送数据包，其中逻辑路径包括多个数据链路。沿独立的数据链路传送数据包时，需要把数据包封装在帧中，并且使用数据链路标识（如MAC地址）让帧可以从链路的源点到达目的地。

数据链路上的设备需要一种方法发现邻居的数据链路标识，以便将数据帧传送到正确的目的地，IPv4使用ARP这种方法（详见[RFC826](https://tools.ietf.org/html/rfc826)）。

当一台设备需要发现另一台设备的数据链路标识符时，它将建立一个ARP请求数据包，这个请求数据包中包括目标设备的IP地址以及发送者的IP和数据链路标识符（MAC地址）。然后ARP请求数据包被封装在数据帧中，该帧的源MAC为发送者，目的MAC为广播地址。

![ARP](https://raw.githubusercontent.com/zyywo/zyywo.pic/master/ARP%E6%8A%A5%E6%96%87.png "ARP报文")

**硬件类型**：以太网为1。

**协议类型**：指明了网络层协议的类型，IP对应0x0800。

**硬件地址长度**：指定了数据链路标识符的长度，单位是1字节，MAC地址的长度为6。

**协议地址长度**：指定了网络层地址的长度，单位是1字节，IPv4地址的长度为4。

**操作**：指明了一个数据包是ARP请求（1）还是ARP响应（2），或其他。

#### 代理ARP
人如其名，代理ARP，详见[RFC925](https://tools.ietf.org/html/rfc925)和[RFC1027](https://tools.ietf.org/html/rfc1027)。

#### 无故ARP
主机偶尔也会使用自己的IPv4地址作为目标地址发送ARP请求，这种ARP请求称为无故ARP。
- 无故ARP可以用于检查重复地址。一台设备可以向自己的IPv4地址发送ARP请求，如果发到ARP响应则表明存在重复地址。
- 无故ARP还可以用于通告一个新的数据链路标识符。当一台设备收到一个ARP请求，如果ARP高速缓冲中已有发送者的IPv4地址，那么与此IPv4地址相对应的硬件地址将会被发送者新的硬件地址所更新。
- 运行热备份路由器协议（HSRP）的路由器如果从其他路由器变成了主路由器，它就会发出一个无故ARP来更新网络上主机的ARP缓存。

#### ICMP (Internet 消息控制协议)
![ICMP报文格式](https://raw.githubusercontent.com/zyywo/zyywo.pic/master/ICMP%E6%8A%A5%E6%96%87.png "ICMP报文格式")

ICMP报文可以通过类型来标识，而许多类型有多个子类型，可以用代码字段来标识它们。详见[RFC1700](https://tools.ietf.org/html/rfc1700)。

### 传输层（主机到主机层）
#### TCP（传输控制协议）
TCP向应用提供了可靠的、面向连接的服务，也就是说TCP提供了一个类似于点到点的连接。

点到点的连接有两个特点：
- 仅存在一条到达目的地的路径。进入连接的数据包不会丢失，因为数据包惟一可去的地方就是连接的另一端。
- 数据包到达的顺序与发送顺序相同。

TCP使用了3种基础的机制实现面向连接的服务：
- 使用序列号对数据包进行标记，以便TCP接收服务在向目的应用传递数据之前修正错序的数据包。
- TCP 使用确认、校验和定时器系统提供可靠性。当接收者按照顺序识别出数据包未能到达或发生错误时，或者接收者在特定时间内没有发送确认信息，那么发送者就会认为在发送结束后数据包没有到达接收方。在这两种情况下，发送者都会考虑重传数据包。
- TCP 使用窗口机制调整数据包的流量。窗口机制可以减少因接收方缓冲区满而造成丢失数据包的可能性。

![TCP header](https://raw.githubusercontent.com/zyywo/zyywo.pic/master/TCP%E6%8A%A5%E5%A4%B4.png "TCP报文头部")

**序列号(Sequence Number)**：序列号确定了发送方发送的数据流中被封装的数据所在位置。例如，本段数据的序列号为1343,且数据段长512字节，那么下一数据段的序列号应该为1343+512+1=1856。

**确认号(Acknowleggment Number)**：确认号确定了源点下一次希望从目标接收的序列号。

**报头长度(Header Length)**：单位为4字节。
	